<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDental â€“ Customer Database</title>
    <meta name="description" content="Live customer viewer for TDental data synced to KOL TG">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2233;
            --bg-row-hover: #1f2d42;
            --bg-input: #0d1322;
            --border: #1e2d45;
            --border-focus: #3b82f6;
            --text-primary: #e8ecf4;
            --text-secondary: #8899b4;
            --text-muted: #556a8a;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.25);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --teal: #14b8a6;
            --pink: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            background: linear-gradient(135deg, #0d1525 0%, #131e35 50%, #0f1a2e 100%);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-inner {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
            background: linear-gradient(135deg, #e8ecf4, #a0b4d0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .header-stat {
            text-align: center;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .header-stat .num {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            font-variant-numeric: tabular-nums;
        }

        .header-stat .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        /* â”€â”€ SEARCH BAR â”€â”€ */
        .toolbar {
            max-width: 1800px;
            margin: 20px auto;
            padding: 0 32px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 280px;
            position: relative;
        }

        .search-box svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all .2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .filter-select {
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            min-width: 180px;
            transition: all .2s;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23556a8a' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .filter-select option {
            background: var(--bg-secondary);
        }

        .result-count {
            font-size: 13px;
            color: var(--text-muted);
            padding: 0 8px;
            white-space: nowrap;
        }

        .result-count strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* â”€â”€ TABLE â”€â”€ */
        .table-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 32px 32px;
            overflow-x: auto;
        }

        .table-wrap {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: rgba(0, 0, 0, 0.3);
            padding: 14px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: color .2s;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th:hover {
            color: var(--accent);
        }

        thead th.sorted {
            color: var(--accent);
        }

        thead th .sort-arrow {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.4;
        }

        thead th.sorted .sort-arrow {
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid rgba(30, 45, 69, 0.5);
            transition: background .15s;
        }

        tbody tr:hover {
            background: var(--bg-row-hover);
        }

        tbody td {
            padding: 12px 12px;
            vertical-align: middle;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .name-info .primary {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .name-info .secondary {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-active {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .badge-inactive {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .badge-treatment {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .badge-gender-m {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
        }

        .badge-gender-f {
            background: rgba(236, 72, 153, 0.1);
            color: #f472b6;
        }

        .money {
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }

        .money-positive {
            color: var(--success);
        }

        .money-zero {
            color: var(--text-muted);
        }

        .money-negative {
            color: var(--danger);
        }

        .text-muted {
            color: var(--text-muted);
        }

        /* â”€â”€ PAGINATION â”€â”€ */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 24px;
        }

        .page-btn {
            padding: 8px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all .2s;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 2px 10px var(--accent-glow);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-info {
            padding: 0 12px;
            font-size: 13px;
            color: var(--text-muted);
        }

        /* â”€â”€ DETAIL PANEL â”€â”€ */
        .detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s;
        }

        .detail-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .detail-panel {
            position: fixed;
            top: 0;
            right: -520px;
            width: 500px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 201;
            overflow-y: auto;
            transition: right .3s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 0;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 5;
        }

        .detail-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .detail-close {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .2s;
        }

        .detail-close:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .detail-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .detail-row {
            display: flex;
            padding: 7px 0;
            gap: 12px;
        }

        .detail-row .label {
            width: 140px;
            flex-shrink: 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .detail-row .value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
            word-break: break-word;
        }

        /* â”€â”€ LOADING â”€â”€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 768px) {
            .header {
                padding: 16px;
            }

            .toolbar {
                padding: 0 16px;
            }

            .table-container {
                padding: 0 16px 16px;
            }

            .header-stats {
                display: none;
            }
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-icon">ðŸ¦·</div>
                <div class="logo-text">
                    <h1>TDental Viewer</h1>
                    <span>Live data from TDental â†’ KOL TG</span>
                </div>
            </div>
            <div class="header-stats" id="headerStats">
                <div class="header-stat">
                    <div class="num" id="statCustomers">â€“</div>
                    <div class="label">Customers</div>
                </div>
                <div class="header-stat">
                    <div class="num" id="statEmployees">â€“</div>
                    <div class="label">Employees</div>
                </div>
                <div class="header-stat">
                    <div class="num" id="statAppointments">â€“</div>
                    <div class="label">Appointments</div>
                </div>
                <div class="header-stat">
                    <div class="num" id="statProducts">â€“</div>
                    <div class="label">Products</div>
                </div>
                <div class="header-stat">
                    <div class="num" id="statCompanies">â€“</div>
                    <div class="label">Branches</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
            <input type="text" id="searchInput" placeholder="Search name, phone, email, ref..." autocomplete="off">
        </div>
        <select class="filter-select" id="companyFilter">
            <option value="">All Branches</option>
        </select>
        <select class="filter-select" id="sortField">
            <option value="name">Sort: Name</option>
            <option value="ref">Sort: Ref Code</option>
            <option value="phone">Sort: Phone</option>
            <option value="company_name">Sort: Branch</option>
            <option value="birth_year">Sort: Birth Year</option>
            <option value="city_name">Sort: City</option>
            <option value="amount_treatment_total">Sort: Treatment Total</option>
            <option value="appointment_date">Sort: Last Appointment</option>
            <option value="created_at">Sort: Created</option>
        </select>
        <select class="filter-select" id="sortOrder" style="min-width: 100px;">
            <option value="asc">â†‘ ASC</option>
            <option value="desc">â†“ DESC</option>
        </select>
        <div class="result-count" id="resultCount"></div>
    </div>

    <!-- TABLE -->
    <div class="table-container">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px">#</th>
                        <th style="min-width:200px">Customer</th>
                        <th>Ref</th>
                        <th>Phone</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Branch</th>
                        <th>City</th>
                        <th>Treatment $</th>
                        <th>Revenue $</th>
                        <th>Balance $</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="14" class="loading">
                            <div class="spinner"></div> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- DETAIL OVERLAY -->
    <div class="detail-overlay" id="detailOverlay" onclick="closeDetail()"></div>
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <h2 id="detailName">Customer Details</h2>
            <button class="detail-close" onclick="closeDetail()">âœ•</button>
        </div>
        <div class="detail-body" id="detailBody"></div>
    </div>

    <script>
        const API = '';
        let currentPage = 1;
        let debounceTimer = null;

        // â”€â”€ INIT â”€â”€
        async function init() {
            loadStats();
            loadCompanies();
            loadCustomers();

            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => { currentPage = 1; loadCustomers(); }, 350);
            });
            document.getElementById('companyFilter').addEventListener('change', () => { currentPage = 1; loadCustomers(); });
            document.getElementById('sortField').addEventListener('change', () => loadCustomers());
            document.getElementById('sortOrder').addEventListener('change', () => loadCustomers());
        }

        // â”€â”€ STATS â”€â”€
        async function loadStats() {
            try {
                const res = await fetch(`${API}/api/stats`);
                const d = await res.json();
                document.getElementById('statCustomers').textContent = fmt(d.customers);
                document.getElementById('statEmployees').textContent = fmt(d.employees);
                document.getElementById('statAppointments').textContent = fmt(d.appointments);
                document.getElementById('statProducts').textContent = fmt(d.products);
                document.getElementById('statCompanies').textContent = fmt(d.companies);
            } catch (e) { console.error('Stats error:', e); }
        }

        // â”€â”€ COMPANIES â”€â”€
        async function loadCompanies() {
            try {
                const res = await fetch(`${API}/api/companies`);
                const companies = await res.json();
                const sel = document.getElementById('companyFilter');
                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error('Companies error:', e); }
        }

        // â”€â”€ CUSTOMERS â”€â”€
        async function loadCustomers() {
            const search = document.getElementById('searchInput').value;
            const company = document.getElementById('companyFilter').value;
            const sort = document.getElementById('sortField').value;
            const order = document.getElementById('sortOrder').value;

            const params = new URLSearchParams({
                page: currentPage, per_page: 50,
                search, company, sort, order
            });

            document.getElementById('tableBody').innerHTML = `
        <tr><td colspan="14" class="loading"><div class="spinner"></div> Loading...</td></tr>`;

            try {
                const res = await fetch(`${API}/api/customers?${params}`);
                const data = await res.json();
                renderTable(data);
                renderPagination(data);
                document.getElementById('resultCount').innerHTML =
                    `Showing <strong>${(data.page - 1) * data.per_page + 1}â€“${Math.min(data.page * data.per_page, data.total)}</strong> of <strong>${fmt(data.total)}</strong>`;
            } catch (e) {
                document.getElementById('tableBody').innerHTML =
                    `<tr><td colspan="14" style="padding:40px;text-align:center;color:var(--danger)">Error loading data: ${e.message}</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (!data.items.length) {
                tbody.innerHTML = `<tr><td colspan="14" style="padding:40px;text-align:center;color:var(--text-muted)">No results found</td></tr>`;
                return;
            }

            const startIdx = (data.page - 1) * data.per_page;
            tbody.innerHTML = data.items.map((c, i) => {
                const initials = (c.name || '?').split(' ').slice(-2).map(w => w[0]).join('').slice(0, 2);
                const gradients = [
                    'linear-gradient(135deg,#3b82f6,#8b5cf6)',
                    'linear-gradient(135deg,#10b981,#14b8a6)',
                    'linear-gradient(135deg,#ec4899,#f59e0b)',
                    'linear-gradient(135deg,#6366f1,#06b6d4)',
                    'linear-gradient(135deg,#f43f5e,#8b5cf6)',
                ];
                const grad = gradients[(startIdx + i) % gradients.length];

                return `<tr onclick="showDetail(${JSON.stringify(c).replace(/"/g, '&quot;')})" style="cursor:pointer">
            <td class="text-muted">${startIdx + i + 1}</td>
            <td>
                <div class="cell-name">
                    <div class="avatar" style="background:${grad}">${initials}</div>
                    <div class="name-info">
                        <div class="primary">${esc(c.display_name || c.name)}</div>
                        <div class="secondary">${esc(c.email || '')}</div>
                    </div>
                </div>
            </td>
            <td><span style="color:var(--teal);font-weight:500">${esc(c.ref || 'â€”')}</span></td>
            <td>${esc(c.phone || 'â€”')}</td>
            <td>${c.gender ? `<span class="badge ${c.gender === 'male' ? 'badge-gender-m' : 'badge-gender-f'}">${esc(c.gender_display || c.gender)}</span>` : 'â€”'}</td>
            <td>${c.age || c.birth_year || 'â€”'}</td>
            <td style="font-size:12px">${esc(c.company_name || 'â€”')}</td>
            <td style="font-size:12px">${esc(c.city_name || 'â€”')}</td>
            <td class="money ${moneyClass(c.amount_treatment_total)}">${fmtMoney(c.amount_treatment_total)}</td>
            <td class="money ${moneyClass(c.amount_revenue_total)}">${fmtMoney(c.amount_revenue_total)}</td>
            <td class="money ${moneyClass(c.amount_balance)}">${fmtMoney(c.amount_balance)}</td>
            <td>${c.treatment_status ? `<span class="badge badge-treatment">${esc(c.treatment_status)}</span>` : 'â€”'}</td>
            <td style="font-size:12px">${esc(c.source_name || 'â€”')}</td>
            <td>${c.active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>'}</td>
        </tr>`;
            }).join('');
        }

        function renderPagination(data) {
            const pg = document.getElementById('pagination');
            const total = data.total_pages;
            if (total <= 1) { pg.innerHTML = ''; return; }

            let html = `<button class="page-btn" onclick="goPage(1)" ${data.page === 1 ? 'disabled' : ''}>Â«</button>`;
            html += `<button class="page-btn" onclick="goPage(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>â€¹</button>`;

            // Show limited range of pages
            let start = Math.max(1, data.page - 3);
            let end = Math.min(total, data.page + 3);

            if (start > 1) html += `<span class="page-info">...</span>`;
            for (let p = start; p <= end; p++) {
                html += `<button class="page-btn ${p === data.page ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
            }
            if (end < total) html += `<span class="page-info">...</span>`;

            html += `<button class="page-btn" onclick="goPage(${data.page + 1})" ${data.page === total ? 'disabled' : ''}>â€º</button>`;
            html += `<button class="page-btn" onclick="goPage(${total})" ${data.page === total ? 'disabled' : ''}>Â»</button>`;
            html += `<span class="page-info">Page ${data.page} of ${fmt(total)}</span>`;
            pg.innerHTML = html;
        }

        function goPage(p) { currentPage = p; loadCustomers(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // â”€â”€ DETAIL PANEL â”€â”€
        function showDetail(c) {
            document.getElementById('detailName').textContent = c.display_name || c.name || 'Customer';
            document.getElementById('detailOverlay').classList.add('open');
            document.getElementById('detailPanel').classList.add('open');

            const fields = [
                {
                    section: 'ðŸ‘¤ Personal Information', rows: [
                        ['Ref Code', c.ref],
                        ['Full Name', c.name],
                        ['Display Name', c.display_name],
                        ['Phone', c.phone],
                        ['Email', c.email],
                        ['Gender', c.gender_display || c.gender],
                        ['Date of Birth', c.date_of_birth],
                        ['Birth Year', c.birth_year],
                        ['Age', c.age],
                        ['Job Title', c.job_title],
                    ]
                },
                {
                    section: 'ðŸ“ Location', rows: [
                        ['Street', c.street],
                        ['Ward', c.ward_name],
                        ['District', c.district_name],
                        ['City', c.city_name],
                        ['Country', c.country],
                        ['Address', c.address],
                        ['Address V2', c.address_v2],
                    ]
                },
                {
                    section: 'ðŸ¦· Clinical & Financial', rows: [
                        ['Treatment Status', c.treatment_status],
                        ['Customer Status', c.customer_status],
                        ['Customer Type', c.customer_type],
                        ['Member Level', c.member_level],
                        ['Card Type', c.card_type],
                        ['Treatment Total', fmtMoney(c.amount_treatment_total)],
                        ['Revenue Total', fmtMoney(c.amount_revenue_total)],
                        ['Balance', fmtMoney(c.amount_balance)],
                        ['Order State', c.order_state],
                        ['Order Residual', fmtMoney(c.order_residual)],
                        ['Total Debit', fmtMoney(c.total_debit)],
                    ]
                },
                {
                    section: 'ðŸ“… Appointments & Dates', rows: [
                        ['Last Appointment', fmtDate(c.appointment_date)],
                        ['Next Appointment', fmtDate(c.next_appointment_date)],
                        ['Sale Order Date', fmtDate(c.sale_order_date)],
                        ['Last Treatment Complete', fmtDate(c.last_treatment_complete_date)],
                    ]
                },
                {
                    section: 'ðŸ¢ Business', rows: [
                        ['Branch', c.company_name],
                        ['Source', c.source_name],
                        ['Sale Person', c.sale_name],
                        ['Marketing Staff', c.marketing_staff],
                        ['Contact Status', c.contact_status],
                        ['Potential Level', c.potential_level],
                        ['Active', c.active ? 'âœ… Yes' : 'âŒ No'],
                        ['Comment', c.comment],
                    ]
                },
                {
                    section: 'ðŸ• System', rows: [
                        ['Created', fmtDate(c.created_at)],
                        ['Last Synced', fmtDate(c.synced_at)],
                        ['ID', c.id],
                    ]
                },
            ];

            let html = '';
            fields.forEach(s => {
                const visibleRows = s.rows.filter(([l, v]) => v !== null && v !== undefined && v !== '' && v !== 'â€”');
                if (!visibleRows.length) return;
                html += `<div class="detail-section"><h3>${s.section}</h3>`;
                visibleRows.forEach(([label, value]) => {
                    html += `<div class="detail-row"><div class="label">${label}</div><div class="value">${esc(String(value))}</div></div>`;
                });
                html += '</div>';
            });

            document.getElementById('detailBody').innerHTML = html;
        }

        function closeDetail() {
            document.getElementById('detailOverlay').classList.remove('open');
            document.getElementById('detailPanel').classList.remove('open');
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

        // â”€â”€ HELPERS â”€â”€
        function fmt(n) { return n == null ? 'â€“' : Number(n).toLocaleString(); }
        function fmtMoney(v) {
            if (v == null || v === '') return 'â€”';
            const n = Number(v);
            if (n === 0) return '0';
            return n.toLocaleString('vi-VN', { maximumFractionDigits: 0 }) + 'â‚«';
        }
        function fmtDate(d) {
            if (!d) return null;
            try {
                const dt = new Date(d);
                if (isNaN(dt)) return d;
                return dt.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                    dt.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            } catch { return d; }
        }
        function moneyClass(v) {
            if (v == null) return 'money-zero';
            const n = Number(v);
            return n > 0 ? 'money-positive' : n < 0 ? 'money-negative' : 'money-zero';
        }
        function esc(s) {
            if (!s) return '';
            const el = document.createElement('span');
            el.textContent = s;
            return el.innerHTML;
        }

        init();
    </script>
</body>

</html>